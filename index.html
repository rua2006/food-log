<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¥—</text></svg>">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Food Log</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0c0c0f;
    --card: #141418;
    --card2: #1c1c22;
    --border: #2c2c36;
    --accent: #944207;
    --accent-dark: #55c447;
    --accent-glow: rgba(127,255,110,0.12);
    --red: #ff6b6b;
    --text: #f0eff4;
    --muted: #5a5a6e;
    --muted2: #3a3a48;
  }

  html, body { height: 100%; }

  body {
    min-height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: 'Outfit', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 36px 16px 60px;
    background-image:
      linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
    background-size: 32px 32px;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse 80% 50% at 50% -5%, rgba(127,255,110,0.07) 0%, transparent 65%);
    pointer-events: none;
    z-index: 0;
  }

  .wrap {
    width: 100%;
    max-width: 460px;
    position: relative;
    z-index: 1;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  /* â”€â”€ SETUP BANNER (shown until URL is saved) â”€â”€ */
  #setupBanner {
    background: var(--card);
    border: 1.5px solid rgba(127,255,110,0.3);
    border-radius: 14px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  #setupBanner.hidden { display: none; }

  .setup-title {
    font-size: 13px;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 0.04em;
  }

  .setup-steps {
    font-size: 12px;
    color: #aaa;
    line-height: 1.8;
    font-family: 'JetBrains Mono', monospace;
  }

  .setup-steps strong { color: var(--text); }

  .url-input {
    width: 100%;
    background: var(--card2);
    border: 1.5px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    padding: 11px 14px;
    outline: none;
    transition: border-color 0.2s;
  }

  .url-input:focus { border-color: var(--accent); }
  .url-input::placeholder { color: var(--muted); }

  .save-url-btn {
    background: var(--accent);
    color: var(--bg);
    border: none;
    border-radius: 8px;
    font-family: 'Outfit', sans-serif;
    font-weight: 700;
    font-size: 14px;
    padding: 12px;
    cursor: pointer;
    transition: background 0.15s;
  }

  .save-url-btn:hover { background: #91ff82; }

  /* â”€â”€ HEADER â”€â”€ */
  .app-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .logo {
    font-size: 30px;
    font-weight: 900;
    letter-spacing: -1.5px;
    color: var(--accent);
    line-height: 1;
  }

  .reset-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    padding: 5px 10px;
    cursor: pointer;
    transition: border-color 0.15s, color 0.15s;
  }

  .reset-btn:hover { border-color: var(--red); color: var(--red); }

  /* â”€â”€ DATE NAV â”€â”€ */
  .date-nav {
    display: grid;
    grid-template-columns: 48px 1fr 48px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  .nav-arrow {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--muted);
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 14px;
    transition: background 0.15s, color 0.15s;
    -webkit-tap-highlight-color: transparent;
  }

  .nav-arrow:active { background: var(--card2); color: var(--accent); }

  .date-center {
    border-left: 1px solid var(--border);
    border-right: 1px solid var(--border);
    padding: 13px 8px;
    text-align: center;
    position: relative;
    cursor: pointer;
  }

  .date-main {
    font-size: 16px;
    font-weight: 700;
    letter-spacing: -0.3px;
  }

  .date-sub {
    font-size: 11px;
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
    margin-top: 2px;
  }

  input[type="date"]#datePicker {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  /* â”€â”€ CURRENT VALUE â”€â”€ */
  .current-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 16px;
    min-height: 58px;
    transition: border-color 0.3s;
  }

  .current-card.has-value { border-color: rgba(127,255,110,0.25); }

  .current-label {
    font-size: 10px;
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 8px;
  }

  .current-value {
    font-size: 13px;
    line-height: 1.65;
    color: #ccc;
    word-break: break-word;
  }

  .current-value.empty { color: var(--muted); font-style: italic; font-size: 12px; }

  .entry-chip {
    display: inline-block;
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 2px 8px;
    margin: 2px 3px 2px 0;
    font-size: 12px;
    font-family: 'JetBrains Mono', monospace;
    color: #ddd;
  }

  /* â”€â”€ INPUT â”€â”€ */
  .input-group {
    background: var(--card);
    border: 1.5px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .input-group:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  #foodInput {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    padding: 16px;
    min-width: 0;
  }

  #foodInput::placeholder { color: var(--muted); font-size: 13px; }

  .log-btn {
    background: var(--accent);
    border: none;
    color: var(--bg);
    font-family: 'Outfit', sans-serif;
    font-weight: 700;
    font-size: 15px;
    padding: 16px 22px;
    cursor: pointer;
    flex-shrink: 0;
    transition: background 0.15s;
    -webkit-tap-highlight-color: transparent;
  }

  .log-btn:active { background: var(--accent-dark); }
  .log-btn:disabled { background: var(--muted2); color: var(--muted); cursor: not-allowed; }

  .hint {
    font-size: 11px;
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
    text-align: center;
  }

  /* â”€â”€ TOAST â”€â”€ */
  #toast {
    position: fixed;
    bottom: 28px;
    left: 50%;
    transform: translateX(-50%) translateY(16px);
    background: var(--card2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    padding: 10px 22px;
    border-radius: 99px;
    opacity: 0;
    transition: opacity 0.2s, transform 0.2s;
    pointer-events: none;
    white-space: nowrap;
    z-index: 999;
  }

  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  #toast.ok   { border-color: var(--accent); color: var(--accent); }
  #toast.err  { border-color: var(--red); color: var(--red); }

  .spin {
    display: inline-block;
    width: 14px; height: 14px;
    border: 2px solid rgba(0,0,0,0.25);
    border-top-color: var(--bg);
    border-radius: 50%;
    animation: spin 0.5s linear infinite;
    vertical-align: middle;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .cal-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .cal-label {
    font-size: 10px;
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
  }
  .cal-value {
    font-size: 24px;
    font-weight: 900;
    color: var(--accent);
    font-family: 'Outfit', sans-serif;
    letter-spacing: -1px;
  }
  .cal-value.empty { color: var(--muted); font-size: 16px; font-weight: 400; }
  .no-row-msg { font-size: 12px; color: var(--red); font-family: 'JetBrains Mono', monospace; font-style: italic; }

.rainbow {
  background: linear-gradient(30deg, #ff0000, #ff8800, #ffff00, #00cc00, #0088ff, #8800ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

</style>
</head>
<body>
<div class="wrap">

  <!-- â”€â”€ SETUP BANNER â”€â”€ -->
  <div id="setupBanner">
    <div class="setup-title">âš¡ One-time setup</div>
    <div class="setup-steps">
      <strong>1.</strong> Open your Google Sheet<br>
      <strong>2.</strong> Extensions â†’ Apps Script<br>
      <strong>3.</strong> Paste in Code.gs, save<br>
      <strong>4.</strong> Deploy â†’ New deployment â†’ Web app<br>
      &nbsp;&nbsp;&nbsp;&nbsp;Execute as: <strong>Me</strong> Â· Who has access: <strong>Anyone</strong><br>
      <strong>5.</strong> Copy the Web app URL and paste below
    </div>
    <input type="text" class="url-input" id="scriptUrlInput" placeholder="https://script.google.com/macros/s/.../exec">
    <button class="save-url-btn" id="saveUrlBtn">Save & Start Logging â†’</button>
  </div>

  <!-- â”€â”€ MAIN APP â”€â”€ -->
  <div class="app-header">
    <div class="logo rainbow">food log.</div>
    <button class="reset-btn" id="resetBtn">change URL</button>
  </div>

  <div class="date-nav">
    <button class="nav-arrow" id="prevDay">â†</button>
    <div class="date-center">
      <input type="date" id="datePicker">
      <div class="date-main" id="dateMain">â€”</div>
      <div class="date-sub" id="dateSub">â€”</div>
    </div>
    <button class="nav-arrow" id="nextDay">â†’</button>
  </div>

  <div class="current-card" id="currentCard">
    <div class="current-label">In sheet for this date</div>
    <div class="current-value empty" id="currentValue">â€”</div>
  </div>

  <div class="cal-card" id="calCard">
    <div class="cal-label">Total calories</div>
    <div class="cal-value empty" id="calValue">â€”</div>
  </div>

  <div class="input-group">
    <input type="text" id="foodInput" placeholder="Peanut butter (220), two slices bread (160), milk (80)" autocomplete="off" spellcheck="false" inputmode="text">
    <button class="log-btn" id="logBtn">Log</button>
  </div>

  <div class="hint">tap Log or press Enter Â· semicolon-separated by entry</div>

</div>

<div id="toast"></div>

<script>
  const SCRIPT_URL_KEY = 'foodlog_script_url';
  let scriptUrl = localStorage.getItem(SCRIPT_URL_KEY) || '';
  let selectedDate = new Date();
  selectedDate.setHours(0,0,0,0);

  // â”€â”€ Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function checkSetup() {
    const banner = document.getElementById('setupBanner');
    if (scriptUrl) {
      banner.classList.add('hidden');
      loadCurrentValue();
    } else {
      banner.classList.remove('hidden');
    }
  }

  document.getElementById('saveUrlBtn').addEventListener('click', () => {
    const val = document.getElementById('scriptUrlInput').value.trim();
    if (!val.startsWith('https://script.google.com')) {
      toast('Paste the full Apps Script URL', 'err'); return;
    }
    scriptUrl = val;
    localStorage.setItem(SCRIPT_URL_KEY, scriptUrl);
    checkSetup();
    document.getElementById('foodInput').focus();
    toast('âœ“ Connected');
  });

  document.getElementById('resetBtn').addEventListener('click', () => {
    document.getElementById('setupBanner').classList.remove('hidden');
    document.getElementById('scriptUrlInput').value = scriptUrl;
  });

  // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toast(msg, type='ok') {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = `show ${type}`;
    clearTimeout(el._t);
    el._t = setTimeout(() => el.className = '', 2500);
  }

  // â”€â”€ Date UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function fmtISO(d) { return d.toLocaleDateString('en-CA'); } // YYYY-MM-DD

  function fmtDisplay(d) {
    const today = new Date(); today.setHours(0,0,0,0);
    const diff = Math.round((d - today) / 86400000);
    const main = diff === 0 ? 'Today' : diff === -1 ? 'Yesterday' :
                 d.toLocaleDateString('en-US', { weekday: 'long' });
    const sub  = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    return { main, sub };
  }

  function setDate(d) {
    selectedDate = new Date(d);
    selectedDate.setHours(0,0,0,0);
    const { main, sub } = fmtDisplay(selectedDate);
    document.getElementById('dateMain').textContent = main;
    document.getElementById('dateSub').textContent = sub;
    document.getElementById('datePicker').value = fmtISO(selectedDate);
    if (scriptUrl) loadCurrentValue();
  }

  document.getElementById('prevDay').addEventListener('click', () => {
    const d = new Date(selectedDate); d.setDate(d.getDate()-1); setDate(d);
  });
  document.getElementById('nextDay').addEventListener('click', () => {
    const d = new Date(selectedDate); d.setDate(d.getDate()+1); setDate(d);
  });
  document.getElementById('datePicker').addEventListener('change', e => {
    if (e.target.value) setDate(new Date(e.target.value + 'T00:00:00'));
  });

  // â”€â”€ API calls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadCurrentValue() {
    const el    = document.getElementById('currentValue');
    const card  = document.getElementById('currentCard');
    const calEl = document.getElementById('calValue');
    el.textContent = 'â€¦';
    el.className = 'current-value';
    card.classList.remove('has-value');
    calEl.textContent = 'â€”';
    calEl.className = 'cal-value empty';

    try {
      const res  = await fetch(`${scriptUrl}?action=get&date=${fmtISO(selectedDate)}`);
      const data = await res.json();

      if (data.status === 'no_row') {
        el.innerHTML = '<span class="no-row-msg">This date is not in your sheet yet</span>';
        el.className = 'current-value';
      } else if (data.value && data.value.trim()) {
        el.innerHTML = data.value.split(';').map(s => s.trim()).filter(Boolean)
          .map(s => `<span class="entry-chip">${s}</span>`).join(' ');
        el.className = 'current-value';
        card.classList.add('has-value');
        if (data.calories) { calEl.textContent = data.calories + ' kcal'; calEl.className = 'cal-value'; }
      } else {
        el.textContent = 'Nothing logged yet';
        el.className = 'current-value empty';
        if (data.calories) { calEl.textContent = data.calories + ' kcal'; calEl.className = 'cal-value'; }
      }
    } catch {
      el.textContent = 'Could not reach sheet';
      el.className = 'current-value empty';
    }
  }

  async function logFood() {
    const input = document.getElementById('foodInput');
    const btn   = document.getElementById('logBtn');
    const text  = input.value.trim();
    if (!text) return;
    if (!scriptUrl) { toast('Paste your script URL first', 'err'); return; }

    btn.disabled = true;
    btn.innerHTML = '<span class="spin"></span>';

    try {
      const params = new URLSearchParams({ action: 'log', date: fmtISO(selectedDate), food: text });
      const res  = await fetch(`${scriptUrl}?${params}`);
      const data = await res.json();
      if (data.status === 'ok') {
        input.value = '';
        toast('âœ“ logged');
        loadCurrentValue();
      } else if (data.status === 'no_row') {
        toast('This date is not in your sheet yet', 'err');
      } else {
        toast(data.message || 'Error', 'err');
      }
    } catch (err) {
      toast('Could not reach sheet', 'err');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Log';
      input.focus();
    }
  }

  document.getElementById('logBtn').addEventListener('click', logFood);
  document.getElementById('foodInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); logFood(); }
  });

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  setDate(new Date());
  checkSetup();
</script>
</body>
</html>
