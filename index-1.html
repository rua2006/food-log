<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Food Log</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0c0c0f;
    --card: #141418;
    --card2: #1c1c22;
    --border: #2c2c36;
    --accent: #7fff6e;
    --accent-dark: #55c447;
    --accent-glow: rgba(127,255,110,0.15);
    --red: #ff6b6b;
    --text: #f0eff4;
    --muted: #5a5a6e;
    --muted2: #3a3a48;
  }

  html { height: 100%; }

  body {
    min-height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: 'Outfit', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 32px 16px 48px;
    /* subtle grid bg */
    background-image:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 40px 40px;
    background-position: center center;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse 80% 60% at 50% -10%, rgba(127,255,110,0.06) 0%, transparent 70%);
    pointer-events: none;
  }

  .wrap {
    width: 100%;
    max-width: 480px;
    position: relative;
    z-index: 1;
  }

  /* ── SETUP SCREEN ── */
  #setupScreen {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  #setupScreen.hidden, #appScreen.hidden { display: none !important; }

  .setup-logo {
    font-size: 38px;
    font-weight: 900;
    letter-spacing: -2px;
    color: var(--accent);
    margin-bottom: 4px;
  }

  .setup-sub {
    font-size: 13px;
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
    margin-bottom: 12px;
  }

  .step-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 20px;
  }

  .step-num {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background: var(--accent);
    color: var(--bg);
    font-size: 12px;
    font-weight: 700;
    border-radius: 50%;
    margin-bottom: 10px;
  }

  .step-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 6px;
  }

  .step-body {
    font-size: 13px;
    color: #aaa;
    line-height: 1.7;
  }

  .step-body a {
    color: var(--accent);
    text-decoration: none;
  }

  .step-body code {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    background: var(--card2);
    border: 1px solid var(--border);
    padding: 2px 6px;
    border-radius: 4px;
    color: #ddd;
    word-break: break-all;
  }

  .field-label {
    font-size: 11px;
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 6px;
    margin-top: 14px;
  }

  .field-label:first-of-type { margin-top: 0; }

  input[type="text"].setup-input {
    width: 100%;
    background: var(--card2);
    border: 1.5px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    padding: 11px 14px;
    outline: none;
    transition: border-color 0.2s;
  }

  input[type="text"].setup-input:focus { border-color: var(--accent); }
  input[type="text"].setup-input::placeholder { color: var(--muted); }

  .signin-btn {
    width: 100%;
    background: var(--accent);
    color: var(--bg);
    border: none;
    border-radius: 10px;
    font-family: 'Outfit', sans-serif;
    font-size: 15px;
    font-weight: 700;
    padding: 15px;
    cursor: pointer;
    letter-spacing: 0.02em;
    transition: background 0.15s, transform 0.1s, box-shadow 0.2s;
    box-shadow: 0 0 0 0 var(--accent-glow);
  }

  .signin-btn:hover {
    background: #91ff82;
    box-shadow: 0 0 24px var(--accent-glow);
  }

  .signin-btn:active { transform: scale(0.98); }
  .signin-btn:disabled { background: var(--muted2); color: var(--muted); cursor: not-allowed; box-shadow: none; }

  /* ── APP SCREEN ── */
  #appScreen { display: flex; flex-direction: column; gap: 16px; }

  /* Header */
  .app-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 4px;
  }

  .app-logo {
    font-size: 28px;
    font-weight: 900;
    letter-spacing: -1.5px;
    color: var(--accent);
  }

  .signout-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    padding: 5px 10px;
    cursor: pointer;
    transition: border-color 0.15s, color 0.15s;
  }

  .signout-btn:hover { border-color: var(--red); color: var(--red); }

  /* Date navigator */
  .date-nav {
    display: grid;
    grid-template-columns: 44px 1fr 44px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }

  .nav-arrow {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--muted);
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s, color 0.15s;
    padding: 14px;
  }

  .nav-arrow:hover { background: var(--card2); color: var(--accent); }

  .date-center {
    border-left: 1px solid var(--border);
    border-right: 1px solid var(--border);
    padding: 12px 10px;
    text-align: center;
    position: relative;
    cursor: pointer;
  }

  .date-main {
    font-size: 15px;
    font-weight: 600;
    letter-spacing: -0.3px;
  }

  .date-sub {
    font-size: 11px;
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
    margin-top: 2px;
  }

  input[type="date"]#datePicker {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  /* Current value card */
  .current-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    min-height: 64px;
    transition: border-color 0.3s;
  }

  .current-card.has-value { border-color: rgba(127,255,110,0.2); }

  .current-card-label {
    font-size: 10px;
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 8px;
  }

  .current-card-value {
    font-size: 13px;
    line-height: 1.65;
    color: #ccc;
    word-break: break-word;
  }

  .current-card-value.empty { color: var(--muted); font-style: italic; }

  /* Entry items rendered nicely */
  .entry-item {
    display: inline-block;
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 2px 8px;
    margin: 2px 3px 2px 0;
    font-size: 12px;
    font-family: 'JetBrains Mono', monospace;
  }

  /* Input row */
  .input-group {
    background: var(--card);
    border: 1.5px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    display: flex;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .input-group:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  #foodInput {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    padding: 16px;
    min-width: 0;
  }

  #foodInput::placeholder { color: var(--muted); }

  .log-btn {
    background: var(--accent);
    border: none;
    color: var(--bg);
    font-family: 'Outfit', sans-serif;
    font-weight: 700;
    font-size: 14px;
    padding: 16px 22px;
    cursor: pointer;
    letter-spacing: 0.02em;
    transition: background 0.15s;
    flex-shrink: 0;
  }

  .log-btn:hover { background: #91ff82; }
  .log-btn:active { background: var(--accent-dark); }
  .log-btn:disabled { background: var(--muted2); color: var(--muted); cursor: not-allowed; }

  .input-hint {
    font-size: 11px;
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
    text-align: center;
  }

  /* ── TOAST ── */
  #toast {
    position: fixed;
    bottom: 28px;
    left: 50%;
    transform: translateX(-50%) translateY(16px);
    background: var(--card2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    padding: 10px 20px;
    border-radius: 99px;
    opacity: 0;
    transition: opacity 0.2s, transform 0.2s;
    pointer-events: none;
    white-space: nowrap;
    z-index: 999;
  }

  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  #toast.ok { border-color: var(--accent); color: var(--accent); }
  #toast.err { border-color: var(--red); color: var(--red); }

  /* ── LOADING SPINNER ── */
  .spin {
    display: inline-block;
    width: 14px; height: 14px;
    border: 2px solid rgba(0,0,0,0.3);
    border-top-color: var(--bg);
    border-radius: 50%;
    animation: spin 0.5s linear infinite;
    vertical-align: middle;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div class="wrap">

  <!-- ══ SETUP SCREEN ══ -->
  <div id="setupScreen">
    <div>
      <div class="setup-logo">food log.</div>
      <div class="setup-sub">→ google sheets / one-time setup</div>
    </div>

    <!-- Step 1 -->
    <div class="step-card">
      <div class="step-num">1</div>
      <div class="step-title">Create a Google Cloud Project</div>
      <div class="step-body">
        Go to <a href="https://console.cloud.google.com" target="_blank">console.cloud.google.com</a> and sign in with your Google account.<br><br>
        Click <strong>Select a project → New Project</strong>. Name it anything (e.g. "Food Log") and click <strong>Create</strong>.
      </div>
    </div>

    <!-- Step 2 -->
    <div class="step-card">
      <div class="step-num">2</div>
      <div class="step-title">Enable the Google Sheets API</div>
      <div class="step-body">
        In the left menu go to <strong>APIs & Services → Library</strong>.<br><br>
        Search for <strong>Google Sheets API</strong>, click it, then click <strong>Enable</strong>.
      </div>
    </div>

    <!-- Step 3 -->
    <div class="step-card">
      <div class="step-num">3</div>
      <div class="step-title">Create an OAuth Client ID</div>
      <div class="step-body">
        Go to <strong>APIs & Services → Credentials → Create Credentials → OAuth client ID</strong>.<br><br>
        If prompted to configure the consent screen first: click <strong>Configure consent screen → External → Create</strong>. Fill in any app name, your email for both fields, click Save.<br><br>
        Back in Credentials: Application type = <strong>Web application</strong>.<br><br>
        Under <strong>Authorized JavaScript origins</strong> add:<br>
        <code>https://YOUR-USERNAME.github.io</code><br><br>
        Click <strong>Create</strong>. Copy the <strong>Client ID</strong> — you'll paste it below.
      </div>
    </div>

    <!-- Step 4 -->
    <div class="step-card">
      <div class="step-num">4</div>
      <div class="step-title">Host this file on GitHub Pages (free)</div>
      <div class="step-body">
        Go to <a href="https://github.com" target="_blank">github.com</a> → New repository.<br><br>
        Name it exactly: <code>food-log</code>. Make it <strong>Public</strong>. Click <strong>Create repository</strong>.<br><br>
        Upload this HTML file, rename it to <code>index.html</code>.<br><br>
        Go to <strong>Settings → Pages → Branch: main → Save</strong>.<br><br>
        Your app will be live at: <code>https://YOUR-USERNAME.github.io/food-log</code><br><br>
        Add that URL as an authorized origin in your OAuth Client ID too.
      </div>
    </div>

    <!-- Step 5 - credentials input -->
    <div class="step-card">
      <div class="step-num">5</div>
      <div class="step-title">Enter your details below</div>
      <div class="step-body">Paste your credentials and sheet info — saved locally in your browser.</div>

      <div class="field-label">OAuth Client ID</div>
      <input type="text" class="setup-input" id="clientIdInput" placeholder="xxxx.apps.googleusercontent.com">

      <div class="field-label">Google Sheet ID</div>
      <input type="text" class="setup-input" id="sheetIdInput" placeholder="From the URL: /spreadsheets/d/THIS_PART/edit">

      <div class="field-label">Sheet Tab Name</div>
      <input type="text" class="setup-input" id="sheetNameInput" placeholder="Sheet1">
    </div>

    <button class="signin-btn" id="setupSaveBtn">Save & Sign in with Google →</button>
  </div>

  <!-- ══ APP SCREEN ══ -->
  <div id="appScreen" class="hidden">

    <div class="app-header">
      <div class="app-logo">food log.</div>
      <button class="signout-btn" id="signoutBtn">sign out</button>
    </div>

    <!-- Date nav -->
    <div class="date-nav">
      <button class="nav-arrow" id="prevDay">←</button>
      <div class="date-center" id="dateCenter">
        <input type="date" id="datePicker">
        <div class="date-main" id="dateMain">—</div>
        <div class="date-sub" id="dateSub">—</div>
      </div>
      <button class="nav-arrow" id="nextDay">→</button>
    </div>

    <!-- Current sheet value -->
    <div class="current-card" id="currentCard">
      <div class="current-card-label">In sheet for this date</div>
      <div class="current-card-value empty" id="currentValue">Loading…</div>
    </div>

    <!-- Food input -->
    <div class="input-group">
      <input type="text" id="foodInput" placeholder="Bread (100), turkey (80), OJ (90)" autocomplete="off" spellcheck="false" inputmode="text">
      <button class="log-btn" id="logBtn">Log</button>
    </div>

    <div class="input-hint">tap Log or press Enter · appends with semicolon</div>

  </div>
</div>

<div id="toast"></div>

<!-- Google Identity Services — no async, must block so google is defined before our code runs -->
<script src="https://accounts.google.com/gsi/client"></script>

<script>
// ── Config (persisted in localStorage) ──────────────────────────────────
const CFG_KEY = 'foodlog_config';

function loadConfig() {
  try { return JSON.parse(localStorage.getItem(CFG_KEY)) || {}; } catch { return {}; }
}

function saveConfig(cfg) {
  localStorage.setItem(CFG_KEY, JSON.stringify(cfg));
}

let cfg = loadConfig();
let accessToken = null;
let tokenClient = null;
let selectedDate = new Date();
selectedDate.setHours(0,0,0,0);

// ── Toast ────────────────────────────────────────────────────────────────
function toast(msg, type='ok') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `show ${type}`;
  clearTimeout(el._t);
  el._t = setTimeout(() => el.className = '', 2600);
}

// ── Setup screen ─────────────────────────────────────────────────────────
function showSetup() {
  document.getElementById('setupScreen').classList.remove('hidden');
  document.getElementById('appScreen').classList.add('hidden');
  if (cfg.clientId)   document.getElementById('clientIdInput').value  = cfg.clientId;
  if (cfg.sheetId)    document.getElementById('sheetIdInput').value   = cfg.sheetId;
  if (cfg.sheetName)  document.getElementById('sheetNameInput').value = cfg.sheetName || 'Sheet1';
}

function showApp() {
  document.getElementById('setupScreen').classList.add('hidden');
  document.getElementById('appScreen').classList.remove('hidden');
  setDate(new Date());
  document.getElementById('foodInput').focus();
}

// setupSaveBtn listener moved to init block below

// ── Google OAuth ──────────────────────────────────────────────────────────
function initTokenClient() {
  if (!cfg.clientId) return;
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: cfg.clientId,
    scope: 'https://www.googleapis.com/auth/spreadsheets',
    callback: (resp) => {
      if (resp.error) { toast('Sign-in failed: ' + resp.error, 'err'); return; }
      accessToken = resp.access_token;
      showApp();
    },
  });
}

function requestToken() {
  if (!tokenClient) { toast('Setup incomplete', 'err'); return; }
  tokenClient.requestAccessToken({ prompt: '' });
}

document.getElementById('signoutBtn').addEventListener('click', () => {
  if (accessToken) google.accounts.oauth2.revoke(accessToken);
  accessToken = null;
  showSetup();
});

// ── Sheets API ────────────────────────────────────────────────────────────
const SHEETS_BASE = 'https://sheets.googleapis.com/v4/spreadsheets';

function sheetsHeaders() {
  return { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' };
}

async function getSheetData() {
  // Fetch columns A and D
  const range = `${encodeURIComponent(cfg.sheetName)}!A:D`;
  const url = `${SHEETS_BASE}/${cfg.sheetId}/values/${range}`;
  const res = await fetch(url, { headers: sheetsHeaders() });
  if (res.status === 401) { accessToken = null; requestToken(); throw new Error('Token expired'); }
  if (!res.ok) throw new Error(`Sheets error ${res.status}`);
  const data = await res.json();
  return data.values || [];
}

async function getFoodForDate(dateStr) {
  const rows = await getSheetData();
  const row = rows.find(r => r[0] === dateStr);
  return row ? (row[3] || '') : '';
}

async function logFoodToSheet(dateStr, foodText) {
  const rows = await getSheetData();
  const rowIndex = rows.findIndex(r => r[0] === dateStr);

  if (rowIndex !== -1) {
    // Row exists — update column D
    const existing = rows[rowIndex][3] || '';
    const newVal = existing.trim() ? existing + '; ' + foodText : foodText;
    const range = `${encodeURIComponent(cfg.sheetName)}!D${rowIndex + 1}`;
    const url = `${SHEETS_BASE}/${cfg.sheetId}/values/${range}?valueInputOption=USER_ENTERED`;
    const res = await fetch(url, {
      method: 'PUT',
      headers: sheetsHeaders(),
      body: JSON.stringify({ values: [[newVal]] })
    });
    if (res.status === 401) { accessToken = null; requestToken(); throw new Error('Token expired'); }
    if (!res.ok) throw new Error(`Sheets error ${res.status}`);
    return newVal;
  } else {
    // Date not found — append new row with date in A and food in D
    const url = `${SHEETS_BASE}/${cfg.sheetId}/values/${encodeURIComponent(cfg.sheetName)}!A:D:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`;
    // Build row: date in col A (index 0), food in col D (index 3)
    const row = [dateStr, '', '', foodText];
    const res = await fetch(url, {
      method: 'POST',
      headers: sheetsHeaders(),
      body: JSON.stringify({ values: [row] })
    });
    if (res.status === 401) { accessToken = null; requestToken(); throw new Error('Token expired'); }
    if (!res.ok) throw new Error(`Sheets error ${res.status}`);
    return foodText;
  }
}

// ── Date UI ───────────────────────────────────────────────────────────────
function fmtISO(d) { return d.toLocaleDateString('en-CA'); }

function fmtDisplay(d) {
  const today = new Date(); today.setHours(0,0,0,0);
  const diff = Math.round((d - today) / 86400000);
  const day = d.toLocaleDateString('en-US', { weekday: 'long' });
  const short = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  let label = diff === 0 ? 'Today' : diff === -1 ? 'Yesterday' : day;
  return { main: label, sub: short };
}

function setDate(d) {
  selectedDate = new Date(d);
  selectedDate.setHours(0,0,0,0);
  const { main, sub } = fmtDisplay(selectedDate);
  document.getElementById('dateMain').textContent = main;
  document.getElementById('dateSub').textContent = sub;
  document.getElementById('datePicker').value = fmtISO(selectedDate);
  loadCurrentValue();
}

document.getElementById('prevDay').addEventListener('click', () => {
  const d = new Date(selectedDate); d.setDate(d.getDate() - 1); setDate(d);
});
document.getElementById('nextDay').addEventListener('click', () => {
  const d = new Date(selectedDate); d.setDate(d.getDate() + 1); setDate(d);
});
document.getElementById('datePicker').addEventListener('change', e => {
  if (e.target.value) setDate(new Date(e.target.value + 'T00:00:00'));
});

// ── Load current value ────────────────────────────────────────────────────
async function loadCurrentValue() {
  const el = document.getElementById('currentValue');
  const card = document.getElementById('currentCard');
  el.textContent = 'Loading…';
  el.className = 'current-card-value';
  card.classList.remove('has-value');

  try {
    const val = await getFoodForDate(fmtISO(selectedDate));
    if (val.trim()) {
      // Render each semicolon-separated entry as a chip
      el.innerHTML = val.split(';').map(s => s.trim()).filter(Boolean)
        .map(s => `<span class="entry-item">${s}</span>`).join(' ');
      el.className = 'current-card-value';
      card.classList.add('has-value');
    } else {
      el.textContent = 'Nothing logged yet';
      el.className = 'current-card-value empty';
    }
  } catch (err) {
    el.textContent = 'Could not load';
    el.className = 'current-card-value empty';
  }
}

// ── Log food ──────────────────────────────────────────────────────────────
async function logFood() {
  const input = document.getElementById('foodInput');
  const btn = document.getElementById('logBtn');
  const text = input.value.trim();
  if (!text) return;
  if (!accessToken) { requestToken(); return; }

  btn.disabled = true;
  btn.innerHTML = '<span class="spin"></span>';

  try {
    await logFoodToSheet(fmtISO(selectedDate), text);
    input.value = '';
    toast('✓ logged');
    loadCurrentValue();
  } catch (err) {
    toast(err.message || 'Error writing to sheet', 'err');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Log';
    input.focus();
  }
}

document.getElementById('logBtn').addEventListener('click', logFood);
document.getElementById('foodInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') { e.preventDefault(); logFood(); }
});

// ── Init ──────────────────────────────────────────────────────────────────
// Wait for google object, then optionally trigger sign-in
function waitForGoogle(cb) {
  if (window.google && google.accounts) { cb(); return; }
  const t = setInterval(() => {
    if (window.google && google.accounts) { clearInterval(t); cb(); }
  }, 100);
  setTimeout(() => clearInterval(t), 8000);
}

function startAuth(showPrompt) {
  if (!cfg.clientId) { showSetup(); return; }
  initTokenClient();
  tokenClient.requestAccessToken({ prompt: showPrompt ? 'select_account' : 'none' });
}

// Button: Save & Sign in
document.getElementById('setupSaveBtn').addEventListener('click', () => {
  const clientId  = document.getElementById('clientIdInput').value.trim();
  const sheetId   = document.getElementById('sheetIdInput').value.trim();
  const sheetName = document.getElementById('sheetNameInput').value.trim() || 'Sheet1';
  if (!clientId || !sheetId) { toast('Please fill in Client ID and Sheet ID', 'err'); return; }
  cfg = { clientId, sheetId, sheetName };
  saveConfig(cfg);
  waitForGoogle(() => startAuth(true));
});

window.addEventListener('load', () => {
  if (cfg.clientId && cfg.sheetId) {
    waitForGoogle(() => startAuth(false));
  } else {
    showSetup();
  }
});
</script>
</body>
</html>
